<div class="change-password-container">
  <div class="card change-password-card">
    <div class="card-header text-center">
      <h3 *ngIf="currentUser?.primerLogin">Cambio Obligatorio de Contraseña</h3>
      <h3 *ngIf="!currentUser?.primerLogin">Cambiar Contraseña</h3>
      <p class="text-muted" *ngIf="currentUser?.primerLogin">
        Tu contraseña es temporal. Por favor, cámbiala para continuar.
      </p>
    </div>
    <div class="card-body">
      <form [formGroup]="passwordForm" (ngSubmit)="onSubmit()">
        <div class="mb-3">
          <label for="oldPassword" class="form-label">Contraseña Actual</label>
          <input
            type="password"
            id="oldPassword"
            formControlName="oldPassword"
            class="form-control"
            [ngClass]="{ 'is-invalid': oldPassword?.invalid && (oldPassword?.dirty || oldPassword?.touched) }"
          />
          <div *ngIf="oldPassword?.invalid && (oldPassword?.dirty || oldPassword?.touched)" class="invalid-feedback">
            <div *ngIf="oldPassword?.errors?.['required']">La contraseña actual es requerida.</div>
          </div>
        </div>

        <div class="mb-3">
          <label for="newPassword" class="form-label">Nueva Contraseña</label>
          <input
            type="password"
            id="newPassword"
            formControlName="newPassword"
            class="form-control"
            [ngClass]="{ 'is-invalid': newPassword?.invalid && (newPassword?.dirty || newPassword?.touched) }"
          />
          <div *ngIf="newPassword?.invalid && (newPassword?.dirty || newPassword?.touched)" class="invalid-feedback">
            <div *ngIf="newPassword?.errors?.['required']">La nueva contraseña es requerida.</div>
            <div *ngIf="newPassword?.errors?.['minlength']">Debe tener al menos 6 caracteres.</div>
            <div *ngIf="newPassword?.errors?.['maxlength']">No debe exceder los 40 caracteres.</div>
          </div>
        </div>

        <div class="mb-3">
          <label for="confirmNewPassword" class="form-label">Confirmar Nueva Contraseña</label>
          <input
            type="password"
            id="confirmNewPassword"
            formControlName="confirmNewPassword"
            class="form-control"
            [ngClass]="{ 'is-invalid': confirmNewPassword?.invalid && (confirmNewPassword?.dirty || confirmNewPassword?.touched) || passwordForm.errors?.['mismatch'] && (confirmNewPassword?.dirty || confirmNewPassword?.touched) }"
          />
          <div *ngIf="confirmNewPassword?.invalid && (confirmNewPassword?.dirty || confirmNewPassword?.touched) || passwordForm.errors?.['mismatch'] && (confirmNewPassword?.dirty || confirmNewPassword?.touched)" class="invalid-feedback">
            <div *ngIf="confirmNewPassword?.errors?.['required']">La confirmación de la contraseña es requerida.</div>
            <div *ngIf="passwordForm.errors?.['mismatch']">Las contraseñas no coinciden.</div>
          </div>
        </div>

        <div *ngIf="isChangeFailed" class="alert alert-danger mt-3">
          {{ errorMessage }}
        </div>
        <div *ngIf="isSuccessful" class="alert alert-success mt-3">
          {{ errorMessage }}
        </div>

        <div class="d-grid gap-2">
          <button type="submit" class="btn btn-primary" [disabled]="passwordForm.invalid || isProcessing">
            <span *ngIf="isProcessing" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
            <span *ngIf="!isProcessing">Cambiar Contraseña</span>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>